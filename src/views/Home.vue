<template>
  <div class="home bg-white">
    <!-- Search Section -->
    <SearchSection 
      @search="handleSearch" 
      :initialSearchTerm="searchTerm"
    />

    <!-- Search Results -->
    <SearchResultsSection 
      v-if="searchResults.length > 0" 
      :search-results="searchResults"
    />

    <!-- New Arrivals Carousel -->
    <NewArrivalsCarousel 
      :new-products="newProducts"
      @product-click="goToProduct"
    />

    <!-- Feature Section -->
    <FeatureSection />

    <!-- Series Section -->
    <SeriesSection 
      :series-list="seriesList"
      @series-click="goToSeries"
    />

    <!-- Hot Products Section -->
    <HotProductsSection 
      :hot-products="hotProducts"
      @product-click="goToProduct"
    />
  </div>
  <Newsletter />
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useProductStore } from '@/store/product';
import type { ProductBaseVO, Series } from '@/types';
import Newsletter from '@/components/Newsletter.vue';
import SearchSection from './home/components/SearchSection.vue';
import SearchResultsSection from './home/components/SearchResultsSection.vue';
import NewArrivalsCarousel from './home/components/NewArrivalsCarousel.vue';
import FeatureSection from './home/components/FeatureSection.vue';
import SeriesSection from './home/components/SeriesSection.vue';
import HotProductsSection from './home/components/HotProductsSection.vue';

const productStore = useProductStore();
const router = useRouter();

const searchTerm = ref('');
const searchResults = ref<ProductBaseVO[]>([]);
const newProducts = ref<ProductBaseVO[]>([]);
const seriesList = ref<Series[]>([]);
const hotProducts = ref<ProductBaseVO[]>([]);

const handleSearch = async (term: string) => {
  searchTerm.value = term;
  if (term.length > 0) {
    searchResults.value = await productStore.searchProducts(term);
  } else {
    searchResults.value = [];
  }
};

// Fetch initial data
onMounted(async () => {
  try {
    [newProducts.value, seriesList.value, hotProducts.value] = await Promise.all([
      productStore.getNewProducts(),
      productStore.getHotSeries(),
      productStore.getHotProducts()
    ]);
  } catch (error) {
    console.error('Failed to fetch initial data:', error);
  }
});

const goToProduct = (product: ProductBaseVO) => {
  router.push({ name: 'product-detail', params: { id: product.appId } });
};

const goToSeries = (series: Series) => {
  router.push(`/categories/${series.slug}`);
};
</script>

<style scoped>
.home {
  width: 100%;
  max-width: 100vw;
  overflow-x: hidden;
}
</style>